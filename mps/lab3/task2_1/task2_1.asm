.include "m8515def.inc" ;???? ??????????? ??? ATmega8515
.def temp1 = r16 ;????????? ??????? 1
.def temp2 = r17 ;????????? ??????? 2
.equ led = 0 ;0-? ??? ????? PB
.equ start = 0 ;0-? ??? ????? PA
.equ stop = 1 ;1-? ??? ????? PA
.macro reload_timer ;??????
 ldi temp1,high(7880) ; ??? ???????? ?
 ldi temp2,low(7880) ; ??????
 out TCNT1H,temp1 ; ????????? ????????
 out TCNT1L,temp2 ; ??? ?????? ???????
.endmacro
;***??????? ???????? ??????????***
.org $0000
 rjmp INIT ; ????????? ??????
.org $0006
 rjmp T1_OVF ; ????????? ???????????? ???????
;***????????????? ??***
INIT:
 ldi temp1,high(RAMEND) ;?????????
 out SPH,temp1 ; ????????? ?????
 ldi temp1,low(RAMEND) ; ?? ?????????
 out SPL,temp1 ; ?????? ??
 ser temp1 ;????????????? ???????
 out DDRB,temp1 ; ????? PB ?? ?????
 out PORTB,temp1 ;???????? LED
 clr temp1 ;?????????????
 out DDRA,temp1 ; ????? PA ?? ????
 ldi temp1,0b00000011 ;????????? ?????????????
 out PORTA,temp1 ; ?????????? ????? PA
 reload_timer ;???????? ? ?????? ????????? ????????
 ldi temp1,(1<<TOIE1) ;?????????? ??????????
 out TIMSK,temp1 ; ??????? ?? ????????????
11
 set ;????????? ????? ?=1
 sei ;?????????? ?????????? ??????????
test_start:
 sbic PINA,start ;???????? ????????? ?????? start
 rjmp test_stop
 ldi temp1,((1<<CS11)|(1<<CS10))
 out TCCR1B,temp1 ; ????????? ??????? ? ?????????????
wait_0:
 sbis PINA,start ;???????? ?????????? ??????
 rjmp wait_0
test_stop:
 sbic PINA,stop ;???????? ????????? ?????? stop
 rjmp test_start
 clr temp1
 out TCCR1B,temp1 ;?????????? ???????
wait_1:
 sbis PINA,stop ;???????? ?????????? ??????
 rjmp wait_1
 rjmp test_start
;***????????? ?????????? ??? ???????????? ??????? T1
T1_OVF:
 clr temp1
 out TCCR1B,temp1 ;?????????? ???????
 brts switch_on ;???????? ???????? ? ????? ?
 sbi PORTB,led ;?????????? LED
 set ;????????? ????? ?=1
 rjmp set_timer
switch_on:
 cbi PORTB,led ;????????? LED
 clt ;????? ????? ?=0
set_timer:
 reload_timer ;???????? ? ?????? ????????? ????????
 ldi temp1,((1<<CS11)|(1<<CS10))
 out TCCR1B,temp1 ; ????????? ???????
 reti
